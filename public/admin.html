<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .sidebar {
      background-color: #f8f9fa;
      min-height: 100vh;
      border-right: 1px solid #dee2e6;
    }

    .sidebar .list-group-item {
      border: none;
      border-radius: 0;
    }

    .sidebar .list-group-item:hover {
      background-color: #e9ecef;
    }

    .sidebar .list-group-item.active {
      background-color: #0d6efd;
      color: white;
    }

    .sidebar .list-group-item a {
      text-decoration: none;
      color: inherit;
      display: block;
      width: 100%;
    }

    .main-content {
      padding: 20px;
    }

    .autocomplete-items {
      border: 1px solid #d4d4d4;
      border-top: none;
      z-index: 99;
      max-height: 200px;
      overflow-y: auto;
    }

    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }

    .table img {
      object-fit: cover;
    }

    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .btn-group-sm .btn {
      margin-right: 2px;
    }

    .alert {
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .sidebar {
        min-height: auto;
      }

      .main-content {
        padding: 10px;
      }

      .table-responsive {
        font-size: 0.875rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 main-content">
        <div id="form-container">
          <!-- Content will be dynamically loaded here -->
          <div class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JavaScript (Optional, for better UI interactions) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Permissions Helper Script (must be loaded first) -->
  <script src="/js/permissions.js"></script>
  
  <!-- Shared Sidebar Component -->
  <script src="/js/sidebar.js"></script>
  
  <script>
    // Check permissions on page load and conditionally show/hide menu items
    document.addEventListener('DOMContentLoaded', () => {
      // You'll need to set the user role after login
      // For now, this is a placeholder - implement based on your auth flow
      // Example: setUserRole('super_admin') or setUserRole('operator')
      
      // Fetch user role and set permissions-based menu visibility
      (async () => {
        try {
          const response = await fetch('/sudobe/api/auth/me');
          if (response.ok) {
            const result = await response.json();
          if (result.success && result.user) {
            const userRole = result.user.role;
            if (userRole && typeof setUserRole === 'function') {
              setUserRole(userRole);
              
              // Hide/show menu items based on permissions
              const menuItems = {
                'orders-menu-item': 'view_orders',
                'logs-menu-item': 'view_logs',
                'permissions-menu-item': 'manage_roles',
              };
              
              Object.entries(menuItems).forEach(([menuId, permission]) => {
                const menuItem = document.getElementById(menuId);
                if (menuItem) {
                  if (hasPermission(permission, userRole)) {
                    menuItem.style.display = 'block';
                  } else {
                    menuItem.style.display = 'none';
                  }
                }
              });
            }
          }
          }
        } catch (error) {
          console.error('Error loading user permissions:', error);
        }
      })();
    });
  </script>

  <!-- Your custom admin script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const section = params.get('section') || 'banners-list';
      const status = params.get('status');
      const message = params.get('message');

      const formContainer = document.getElementById('form-container');

      if (status && message) {
        const alertType = status === 'success' ? 'success' : 'danger';
        const alertHtml = `
              <div class="alert alert-${alertType} alert-dismissible fade show" role="alert">
                ${decodeURIComponent(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
        formContainer.insertAdjacentHTML('afterbegin', alertHtml);
        window.history.replaceState({}, document.title, window.location.pathname + '?section=' + section);
      }

      // Route to appropriate section
      switch (section) {
        case 'banners-list':
          loadBannerList();
          break;
        case 'banner-form':
          loadBannerForm();
          break;
        case 'banner-edit':
          const bannerId = params.get('id');
          loadBannerEditForm(bannerId);
          break;
        case 'protections-list':
          loadProtectionList();
          break;
        case 'protection':
        case 'protection-form':
          loadProtectionForm();
          break;
        case 'protection-edit':
          const protectionId = params.get('id');
          loadProtectionEditForm(protectionId);
          break;
        case 'images-list':
          loadImagesList();
          break;
        case 'image-upload':
          loadImageUploadForm();
          break;
        case 'banking':
          loadBankingForm();
          break;
        case 'products':
            loadProducts();
            break;
        case 'products-list':
            const productPage = parseInt(params.get('page')) || 1;
            loadProductsList(productPage);
            break;
        default:
          loadBannerList();
      }

      // Highlight active menu item
      document.querySelectorAll('.sidebar .list-group-item').forEach(item => {
        const link = item.querySelector('a');
        if (link) {
          const href = link.getAttribute('href');
          
          // Check if this is a section-based link
          if (href.includes('section=')) {
            const linkSection = href.split('section=')[1]?.split('&')[0];
            const activeSection = section.split('-')[0]; // Get base section name
            
            // Match exact section or base section
            if (linkSection === section ||
              (linkSection === 'banners-list' && (activeSection === 'banner' || section === 'banner-edit' || section === 'banner-form')) ||
              (linkSection === 'protections-list' && (activeSection === 'protection' || section === 'protection-edit' || section === 'protection-form')) ||
              (linkSection === 'images-list' && (activeSection === 'image' || section === 'image-upload'))) {
              item.classList.add('active');
            } else {
              item.classList.remove('active');
            }
          } else {
            // For routes without section parameter, check if current path matches
            const currentPath = window.location.pathname;
            if (href === currentPath) {
              item.classList.add('active');
            } else {
              item.classList.remove('active');
            }
          }
        }
      });

      // === Banner Functions ===
      function loadBannerList() {
        fetch('/sudobe/api/content/banners')
          .then(res => res.json())
          .then(banners => {
            let html = `
                  <div class="d-flex justify-content-between align-items-center mb-4 gap-3">
                    <h2><i class="bi bi-image me-2"></i>Banner Management</h2>

                    <div class="d-flex justify-content-end align-items-center mb-4 gap-3">
                      <a href="?section=banner-form" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Add New Banner
                      </a>
                        <a href="/sudobe/api/auth/logout" class="btn btn-primary">
                        <i class="bi bi-arrow-right me-1"></i>Logout
                      </a>
                    </div>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead class="table-dark">
                            <tr>
                              <th>ID</th>
                              <th>Type</th>
                              <th>Value</th>
                              <th>Image</th>
                              <th>Priority</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                `;

            if (banners && banners.length > 0) {
              banners.forEach(b => {
                html += `
                      <tr>
                        <td><code>${b.id.substring(0, 8)}...</code></td>
                        <td><span class="badge bg-info">${b.content?.link_type || 'N/A'}</span></td>
                        <td class="text-truncate" style="max-width: 150px;">${b.content?.data_id || 'N/A'}</td>
                        <td>
                          ${b.content?.image?.url ?
                    `<img src="${b.content.image.url}" width="80" height="50" class="img-thumbnail" />` :
                    '<span class="text-muted">No image</span>'
                  }
                        </td>
                        <td class="text-truncate" style="max-width: 150px;">${b.content?.priority || 'N/A'}</td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" onclick="editBanner('${b.id}')" title="Edit">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteBanner('${b.id}')" title="Delete">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    `;
              });
            } else {
              html += `
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-1 d-block mb-3"></i>
                        No banners found. <a href="?section=banner-form">Create your first banner</a>
                      </td>
                    </tr>
                  `;
            }

            html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                `;
            formContainer.innerHTML = html;
          })
          .catch(error => {
            console.error('Error loading banners:', error);
            formContainer.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading banners. Please try again.
                  </div>
                `;
          });
      }

      function loadBannerForm(editData = null) {
        const isEdit = editData !== null;
        const title = isEdit ? 'Edit Banner' : 'Create New Banner';
        const submitText = isEdit ? 'Save Banner' : 'Create Banner';

        formContainer.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-${isEdit ? 'pencil' : 'plus-circle'} me-2"></i>${title}</h2>
                <a href="?section=banners-list" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">${title}</h5>
                </div>
                <div class="card-body">
                  <form id="bannerForm" enctype="multipart/form-data">
                    <div class="mb-3">
                      <label class="form-label">Banner Type <span class="text-danger">*</span></label>
                      <select name="bannerType" id="bannerType" class="form-select" required>
                        <option value="">-- Select Type --</option>
                        <option value="category" ${editData?.content?.link_type === 'category' ? 'selected' : ''}>Category</option>
                        <option value="product" ${editData?.content?.link_type === 'product' ? 'selected' : ''}>Product</option>
                        <option value="factory" ${editData?.content?.link_type === 'factory' ? 'selected' : ''}>Factory</option>
                      </select>
                    </div>
                    <div class="mb-3" id="valueContainer"></div>
                    <div class="mb-3">
                      <label class="form-label">Banner Image ${isEdit ? '' : '<span class="text-danger">*</span>'}</label>
                      <input type="file" name="bannerImage" id="bannerImage" class="form-control" accept="image/*" ${isEdit ? '' : 'required'} />
                      ${editData?.content?.image?.url ?
            `<div class="mt-3">
                          <label class="form-label text-muted">Current Image:</label><br>
                          <img src="${editData.content.image.url}" width="200" class="img-thumbnail" />
                        </div>` : ''
          }
                      ${isEdit ? '<small class="form-text text-muted">Leave empty to keep current image</small>' : ''}
                    </div>

<div class="mb-3">
  <label for="priority" class="form-label">Priority <span class="text-danger">*</span></label>
  <input
    type="number"
    class="form-control"
    id="priority"
    name="priority"
    required
    value="${isEdit && editData?.content?.priority ? editData.content.priority : ''}"
  />
</div>
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-${isEdit ? 'check-circle' : 'plus-circle'} me-1"></i>${submitText}
                      </button>
                      <a href="?section=banners-list" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            `;

        // Handle form submission
        document.getElementById('bannerForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          formData.append("priority", document.getElementById("priority").value);

          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
          submitBtn.disabled = true;

          try {
            let response;
            if (isEdit) {
              response = await fetch(`/sudobe/api/content/banners/${editData.id}`, {
                method: 'PUT',
                body: formData
              });
            } else {
              response = await fetch('/sudobe/api/content', {
                method: 'POST',
                body: formData
              });
            }

            if (response.ok) {
              window.location.href = '?section=banners-list&status=success&message=' +
                encodeURIComponent(`Banner ${isEdit ? 'updated' : 'created'} successfully`);
            } else {
              throw new Error('Server error');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error saving banner. Please try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        });

        // Setup banner type change handler
        setupBannerTypeHandler(editData);
      }

      function loadBannerEditForm(bannerId) {
        formContainer.innerHTML = `
              <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Loading banner details...</p>
              </div>
            `;

        fetch(`/sudobe/api/content/banners`)
          .then(res => res.json())
          .then(banners => {
            const banner = banners.find(b => b.id === bannerId);
            if (banner) {
              loadBannerForm(banner);
            } else {
              formContainer.innerHTML = `
                    <div class="alert alert-danger">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      Banner not found
                    </div>
                  `;
            }
          })
          .catch(error => {
            console.error('Error loading banner:', error);
            formContainer.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading banner
                  </div>
                `;
          });
      }

      function setupBannerTypeHandler(editData = null) {
        document.getElementById('bannerType').addEventListener('change', async (e) => {
          const type = e.target.value;
          const container = document.getElementById('valueContainer');
          container.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading options...</div>';

          try {
            let html = '';
            if (type === 'category') {
              const res = await fetch('/sudobe/api/content/categories');
              const categories = await res.json();
              html += `<label class="form-label">Select Category <span class="text-danger">*</span></label>
                           <select name="bannerValue" class="form-select" required>`;
              html += `<option value="">-- Select Category --</option>`;
              categories.forEach(c => {
                const selected = editData?.content?.data_id === c.id ? 'selected' : '';
                html += `<option value="${c.id}" ${selected}>${c.name}</option>`;
              });
              html += `</select>`;
            } else if (type === 'factory') {
              const res = await fetch('/sudobe/api/content/factories');
              const factories = await res.json();
              html += `<label class="form-label">Select Factory <span class="text-danger">*</span></label>
                           <select name="bannerValue" class="form-select" required>`;
              html += `<option value="">-- Select Factory --</option>`;
              factories.forEach(f => {
                const selected = editData?.content?.data_id === f.id ? 'selected' : '';
                html += `<option value="${f.id}" ${selected}>${f.content?.factory_name || f.name || 'Unnamed Factory'}</option>`;
              });
              html += `</select>`;
            } else if (type === 'product') {
              html = `
                    <label class="form-label">Search Product <span class="text-danger">*</span></label>
                    <div class="autocomplete position-relative">
                      <input type="text" id="bannerValueInput" class="form-control" placeholder="Type to search for product..." autocomplete="off">
                      <input type="hidden" name="bannerValue" id="bannerValue" required />
                      <div id="productAutocomplete" class="autocomplete-items position-absolute w-100 bg-white border rounded" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
                    </div>
                  `;
            }

            container.innerHTML = html;

            // Product autocomplete
            if (type === 'product') {
              setupProductAutocomplete(editData);
            }

          } catch (error) {
            console.error('Error loading options', error);
            container.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading options. Please try again.
                  </div>
                `;
          }
        });

        // Trigger change event if editing
        if (editData && editData.content?.link_type) {
          document.getElementById('bannerType').dispatchEvent(new Event('change'));
        }
      }

      function setupProductAutocomplete(editData = null) {
        const input = document.getElementById('bannerValueInput');
        const hiddenInput = document.getElementById('bannerValue');
        const autocomplete = document.getElementById('productAutocomplete');

        // Set initial value if editing
        if (editData?.content?.data_id) {
          hiddenInput.value = editData.content.data_id;
          // Fetch product name for display
          fetch(`/sudobe/api/content/products?search=`)
            .then(res => res.json())
            .then(data => {
              const products = data.results || data || [];
              const product = products.find(p => p.id === editData.content.data_id);
              if (product) {
                input.value = product.name;
              }
            });
        }

        input.addEventListener('input', async function () {
          const term = this.value;
          if (term.length < 2) {
            autocomplete.style.display = 'none';
            autocomplete.innerHTML = '';
            return;
          }

          try {
            const res = await fetch(`/sudobe/api/content/products?search=${encodeURIComponent(term)}`);
            const data = await res.json();
            const products = data.results || data || [];

            autocomplete.innerHTML = '';
            if (products.length > 0) {
              products.forEach(product => {
                const item = document.createElement('div');
                item.classList.add('p-3', 'border-bottom');
                item.style.cursor = 'pointer';
                item.innerHTML = `
                      <div><strong>${product.name}</strong></div>
                      <small class="text-muted">SKU: ${product.sku || 'N/A'}</small>
                    `;
                item.addEventListener('click', () => {
                  input.value = product.name;
                  hiddenInput.value = product.id;
                  autocomplete.style.display = 'none';
                });
                item.addEventListener('mouseenter', () => item.classList.add('bg-light'));
                item.addEventListener('mouseleave', () => item.classList.remove('bg-light'));
                autocomplete.appendChild(item);
              });
              autocomplete.style.display = 'block';
            } else {
              autocomplete.innerHTML = '<div class="p-3 text-muted">No products found</div>';
              autocomplete.style.display = 'block';
            }
          } catch (error) {
            console.error('Error fetching products:', error);
            autocomplete.innerHTML = '<div class="p-3 text-danger">Error loading products</div>';
            autocomplete.style.display = 'block';
          }
        });

        // Close autocomplete when clicking outside
        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !autocomplete.contains(e.target)) {
            autocomplete.style.display = 'none';
          }
        });
      }

      // === Protection Functions ===
      function loadProtectionList() {
        fetch('/sudobe/api/content/protections')
          .then(res => res.json())
          .then(protections => {
            let html = `
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-shield-check me-2"></i>Protection Management</h2>
                    <a href="?section=protection-form" class="btn btn-primary">
                      <i class="bi bi-plus-circle me-1"></i>Add New Protection
                    </a>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead class="table-dark">
                            <tr>
                              <th>ID</th>
                              <th>Title</th>
                              <th>Short Description</th>
                              <th>Icon</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                `;

            if (protections && protections.length > 0) {
              protections.forEach(p => {
                html += `
                      <tr>
                        <td><code>${p.id.substring(0, 8)}...</code></td>
                        <td><strong>${p.content?.title || 'N/A'}</strong></td>
                        <td class="text-truncate" style="max-width: 200px;">${p.content?.short_description || 'N/A'}</td>
                        <td>
                          ${p.content?.icon?.url ?
                    `<img src="${p.content.icon.url}" width="40" height="40" class="img-thumbnail"/>` :
                    '<span class="text-muted">No icon</span>'
                  }
                        </td>
                        <td>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-warning" onclick="editProtection('${p.id}')" title="Edit">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProtection('${p.id}')" title="Delete">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                    `;
              });
            } else {
              html += `
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        <i class="bi bi-shield-x display-1 d-block mb-3"></i>
                        No protections found. <a href="?section=protection-form">Create your first protection</a>
                      </td>
                    </tr>
                  `;
            }

            html += `
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                `;
            formContainer.innerHTML = html;
          })
          .catch(error => {
            console.error('Error loading protections:', error);
            formContainer.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading protections. Please try again.
                  </div>
                `;
          });
      }

      function loadImagesList(page = 1) {
        const limit = 20; // Images per page
        
        fetch(`/sudobe/api/content/images?page=${page}&limit=${limit}`)
          .then(res => res.json())
          .then(data => {
            const { images, pagination } = data;
            
            let html = `
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-image me-2"></i>Image Management</h2>
                    <div class="d-flex gap-2">
                      <a href="?section=image-upload" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>Upload Images
                      </a>
                      <a href="/sudobe/api/auth/logout" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-right me-1"></i>Logout
                      </a>
                    </div>
                  </div>
                  <div class="card">
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead class="table-dark">
                            <tr>
                              <th>Preview</th>
                              <th>Filename</th>
                              <th>URL</th>
                              <th>Size</th>
                              <th>Upload Date</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
          `;

      if (images && images.length > 0) {
        images.forEach(img => {
          const fileSize = img.file_size ? (img.file_size / 1024).toFixed(1) + ' KB' : 'N/A';
          const uploadDate = img.date_created ? new Date(img.date_created).toLocaleDateString() : 'N/A';
          
          html += `
                <tr>
                  <td>
                    <img src="${img.url}" width="60" height="40" class="img-thumbnail" style="object-fit: cover;" />
                  </td>
                  <td>
                    <code>${img.filename || 'N/A'}</code>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <input type="text" class="form-control form-control-sm" value="${img.url}" readonly style="font-size: 0.8rem;">
                      <button class="btn btn-outline-secondary btn-sm ms-1" onclick="copyToClipboard('${img.url}')" title="Copy URL">
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                  </td>
                  <td>${fileSize}</td>
                  <td>${uploadDate}</td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-info" onclick="viewImage('${img.url}')" title="View Full Size">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button class="btn btn-outline-danger" onclick="deleteImage('${img.id}')" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `;
        });
      } else {
        html += `
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  <i class="bi bi-image display-1 d-block mb-3"></i>
                  No images found. <a href="?section=image-upload">Upload your first image</a>
                </td>
              </tr>
            `;
      }

      html += `
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

      // Add pagination controls
      if (pagination.totalPages > 1) {
        html += generatePaginationControls(pagination, 'loadImagesList');
      }

      formContainer.innerHTML = html;
    })
    .catch(error => {
      console.error('Error loading images:', error);
      formContainer.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Error loading images. Please try again.
            </div>
          `;
    });
}

function generatePaginationControls(pagination, loadFunction) {
  const { currentPage, totalPages, totalImages, hasNext, hasPrev } = pagination;
  
  let html = `
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div class="text-muted">
        Showing ${((currentPage - 1) * pagination.limit) + 1} to ${Math.min(currentPage * pagination.limit, totalImages)} of ${totalImages} images
      </div>
      <nav aria-label="Images pagination">
        <ul class="pagination pagination-sm mb-0">
  `;

  // Previous button
  if (hasPrev) {
    html += `
      <li class="page-item">
        <button class="page-link" onclick="${loadFunction}(${currentPage - 1})" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </button>
      </li>
    `;
  } else {
    html += `
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
    `;
  }

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += `<li class="page-item"><button class="page-link" onclick="${loadFunction}(1)">1</button></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
    } else {
      html += `<li class="page-item"><button class="page-link" onclick="${loadFunction}(${i})">${i}</button></li>`;
    }
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><button class="page-link" onclick="${loadFunction}(${totalPages})">${totalPages}</button></li>`;
  }

  // Next button
  if (hasNext) {
    html += `
      <li class="page-item">
        <button class="page-link" onclick="${loadFunction}(${currentPage + 1})" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </button>
      </li>
    `;
  } else {
    html += `
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
    `;
  }

  html += `
        </ul>
      </nav>
    </div>
  `;

  return html;
}

function generateProductsPaginationControls(pagination, currentPage) {
  if (!pagination) {
    console.error('Pagination is undefined');
    return '';
  }
  
  const { totalPages = 1, totalProducts = 0, hasNext = false, hasPrev = false, limit = 20 } = pagination;
  
  console.log('Generating pagination:', { totalPages, totalProducts, currentPage, limit });
  
  // Get current filters to preserve in pagination links
  const params = new URLSearchParams(window.location.search);
  const factoryFilter = params.get('factory') || '';
  const searchFilter = params.get('search') || '';
  
  let html = `
    <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3" style="border-top: 1px solid #dee2e6; padding-top: 1rem;">
      <div class="text-muted fw-bold">
        Showing ${((currentPage - 1) * limit) + 1} to ${Math.min(currentPage * limit, totalProducts)} of ${totalProducts} products
      </div>
      <nav aria-label="Products pagination">
        <ul class="pagination mb-0">
  `;

  // Helper function to generate page URL with all filters
  const getPageUrl = (pageNum) => {
    let url = `?section=products-list&page=${pageNum}`;
    if (factoryFilter) {
      url += `&factory=${encodeURIComponent(factoryFilter)}`;
    }
    if (searchFilter) {
      url += `&search=${encodeURIComponent(searchFilter)}`;
    }
    return url;
  };

  // Previous button
  if (hasPrev || currentPage > 1) {
    html += `
      <li class="page-item">
        <a class="page-link" href="${getPageUrl(currentPage - 1)}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
    `;
  } else {
    html += `
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
    `;
  }

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    html += `<li class="page-item"><a class="page-link" href="${getPageUrl(1)}">1</a></li>`;
    if (startPage > 2) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
    } else {
      html += `<li class="page-item"><a class="page-link" href="${getPageUrl(i)}">${i}</a></li>`;
    }
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
    }
    html += `<li class="page-item"><a class="page-link" href="${getPageUrl(totalPages)}">${totalPages}</a></li>`;
  }

  // Next button
  if (hasNext || currentPage < totalPages) {
    html += `
      <li class="page-item">
        <a class="page-link" href="${getPageUrl(currentPage + 1)}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    `;
  } else {
    html += `
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
    `;
  }

  html += `
        </ul>
      </nav>
    </div>
  `;

  return html;
}

      function loadImageUploadForm() {
        formContainer.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-cloud-upload me-2"></i>Upload Images</h2>
                <a href="?section=images-list" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-1"></i>Back to Images
                </a>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Upload Multiple Images</h5>
                </div>
                <div class="card-body">
                  <form id="imageUploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                      <label class="form-label">Select Images <span class="text-danger">*</span></label>
                      <input type="file" name="images" id="images" class="form-control" accept="image/*" multiple required />
                      <small class="form-text text-muted">You can select multiple images at once (max 20 files, 10MB each)</small>
                    </div>
                 
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-cloud-upload me-1"></i>Upload Images
                      </button>
                      <a href="?section=images-list" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            `;

        // Handle form submission
        document.getElementById('imageUploadForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Uploading...';
          submitBtn.disabled = true;

          try {
            const response = await fetch('/sudobe/api/content/images', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (response.ok) {
              window.location.href = '?section=images-list&status=success&message=' +
                encodeURIComponent(result.message || 'Images uploaded successfully');
            } else {
              throw new Error(result.error || 'Upload failed');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error uploading images: ' + error.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        });
      }

      function loadProtectionForm(editData = null) {
        const isEdit = editData !== null;
        const title = isEdit ? 'Edit Protection' : 'Create New Protection';
        const submitText = isEdit ? 'Save Protection' : 'Create Protection';

        formContainer.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-${isEdit ? 'pencil' : 'plus-circle'} me-2"></i>${title}</h2>
                <a href="?section=protections-list" class="btn btn-outline-secondary">
                  <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">${title}</h5>
                </div>
                <div class="card-body">
                  <form id="protectionForm" enctype="multipart/form-data">
                    <div class="mb-3">
                      <label class="form-label">Protection Icon ${isEdit ? '' : '<span class="text-danger">*</span>'}</label>
                      <input type="file" name="proctectionIcon" id="protectionIcon" class="form-control" accept="image/*" ${isEdit ? '' : 'required'} />
                      ${editData?.content?.icon?.url ?
            `<div class="mt-3">
                          <label class="form-label text-muted">Current Icon:</label><br>
                          <img src="${editData.content.icon.url}" width="80" class="img-thumbnail" />
                        </div>` : ''
          }
                      ${isEdit ? '<small class="form-text text-muted">Leave empty to keep current icon</small>' : ''}
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Title <span class="text-danger">*</span></label>
                      <input type="text" name="title" class="form-control" value="${editData?.content?.title || ''}" required placeholder="Enter protection title" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Short Description <span class="text-danger">*</span></label>
                      <input type="text" name="short_description" class="form-control" value="${editData?.content?.short_description || ''}" required placeholder="Brief description" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Long Description <span class="text-danger">*</span></label>
                      <textarea name="long_description" class="form-control" rows="4" required placeholder="Detailed description">${editData?.content?.long_description || ''}</textarea>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-${isEdit ? 'check-circle' : 'plus-circle'} me-1"></i>${submitText}
                      </button>
                      <a href="?section=protections-list" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            `;

        // Handle form submission
        document.getElementById('protectionForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
          submitBtn.disabled = true;

          try {
            let response;
            if (isEdit) {
              response = await fetch(`/sudobe/api/content/protections/${editData.id}`, {
                method: 'PUT',
                body: formData
              });
            } else {
              response = await fetch('/sudobe/api/content/protection', {
                method: 'POST',
                body: formData
              });
            }

            if (response.ok) {
              window.location.href = '?section=protections-list&status=success&message=' +
                encodeURIComponent(`Protection ${isEdit ? 'updated' : 'created'} successfully`);
            } else {
              throw new Error('Server error');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error saving protection. Please try again.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        });
      }

      function loadProducts() {
        formContainer.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-cart me-2"></i>Products</h2>
                <a href="/sudobe/api/auth/logout" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-right me-1"></i>Logout
                </a>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Product Import/Export</h5>
                </div>
                <div class="card-body">
                  <form id="productImportForm" enctype="multipart/form-data">
                    <div class="mb-3">
                      <label class="form-label">Import Products from Excel <span class="text-danger">*</span></label>
                      <input type="file" name="excelFile" id="excelFile" class="form-control" accept=".xlsx,.xls" required />
                      <small class="form-text text-muted">Upload an Excel file (.xlsx or .xls) with product data</small>
                    </div>
                    <div class="d-flex gap-2">
                      <button type="submit" class="btn btn-primary">
                        <i class="bi bi-upload me-1"></i>Import Products
                      </button>
                      <button type="button" id="exportBtn" class="btn btn-secondary">
                        <i class="bi bi-download me-1"></i>Export Products
                      </button>
                      <button type="button" id="exportWithFiltersBtn" class="btn btn-info">
                        <i class="bi bi-funnel me-1"></i>Export Word File
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            `;

        // Handle form submission
        document.getElementById('productImportForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Importing...';
          submitBtn.disabled = true;

          try {
            const response = await fetch('/sudobe/api/content/products', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
              // Show success message
              const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <i class="bi bi-check-circle me-2"></i>
                  ${result.message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            } else {
              // Show detailed error information
              let errorDetails = '';
              
              if (result.template_errors && result.template_errors.length > 0) {
                errorDetails += '<h6 class="mt-3 mb-2">Template Validation Errors:</h6><ul class="mb-2">';
                result.template_errors.forEach(error => {
                  errorDetails += `<li>${error}</li>`;
                });
                errorDetails += '</ul>';
              }
              
              // if (result.available_columns && result.available_columns.length > 0) {
              //   errorDetails += '<h6 class="mt-3 mb-2">Available Columns:</h6>';
              //   errorDetails += '<p class="text-muted small">' + result.available_columns.join(', ') + '</p>';
              // }
              
              // if (result.required_columns && result.required_columns.length > 0) {
              //   errorDetails += '<h6 class="mt-3 mb-2">Required Columns:</h6>';
              //   errorDetails += '<p class="text-muted small">' + result.required_columns.join(', ') + '</p>';
              // }
              
              if (result.data_errors && result.data_errors.length > 0) {
                errorDetails += '<h6 class="mt-3 mb-2">Data Validation Errors:</h6>';
                result.data_errors.forEach((error, index) => {
                  errorDetails += `<div class="mb-2"><strong>Product ${error.main_upc || 'Unknown'}:</strong>`;
                  if (error.row) {
                    errorDetails += ` (Row ${error.row})`;
                  }
                  errorDetails += '<ul class="mb-1">';
                  error.errors.forEach(err => {
                    errorDetails += `<li>${err}</li>`;
                  });
                  errorDetails += '</ul></div>';
                });
              }
              
              if (result.total_rows !== undefined) {
                errorDetails += `<p class="mt-3 mb-0"><strong>Summary:</strong> ${result.total_rows} total rows, ${result.valid_rows || 0} valid rows, ${result.invalid_rows || 0} invalid rows</p>`;
              }

              // Handle the new error format with detailed error information
              let errorMessage = result.message || result.error || 'Unknown error';
              
              // Add detailed error information if available
              if (result.errors && result.errors.length > 0) {
                errorMessage += '<br><br><strong>Detailed Errors:</strong><ul class="mb-0">';
                result.errors.forEach(error => {
                  errorMessage += `<li><strong>Product ${error.mainUPC}:</strong> ${error.error}</li>`;
                });
                errorMessage += '</ul>';
              }

              const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <strong>Error importing products:</strong> ${errorMessage}
                  ${errorDetails}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            }
          } catch (error) {
            console.error('Error importing products:', error);
            const alertHtml = `
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error importing products: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
            formContainer.insertAdjacentHTML('afterbegin', alertHtml);
          } finally {
            // Reset button state
            submitBtn.innerHTML = '<i class="bi bi-upload me-1"></i>Import Products';
            submitBtn.disabled = false;
          }
        });
        
        // Handle export button
        document.getElementById('exportBtn').addEventListener('click', async () => {
          const exportBtn = document.getElementById('exportBtn');
          const originalText = exportBtn.innerHTML;
          
          exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';
          exportBtn.disabled = true;

          try {
            const response = await fetch('/sudobe/api/content/products/export', {
              method: 'GET'
            });

            if (response.ok) {
              // Get filename from Content-Disposition header or use default
              const contentDisposition = response.headers.get('Content-Disposition');
              let filename = 'products_export.xlsx';
              
              if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                  filename = filenameMatch[1];
                }
              }

              // Create blob and download
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);

              // Show success message
              const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <i class="bi bi-check-circle me-2"></i>
                  Products exported successfully! File: ${filename}
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            } else {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Export failed');
            }
          } catch (error) {
            console.error('Error exporting products:', error);
            const alertHtml = `
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error exporting products: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
            formContainer.insertAdjacentHTML('afterbegin', alertHtml);
          } finally {
            // Reset button state
            exportBtn.innerHTML = '<i class="bi bi-download me-1"></i>Export Products';
            exportBtn.disabled = false;
          }
        });
        
        // Handle export with filters button
        document.getElementById('exportWithFiltersBtn').addEventListener('click', async () => {
          // Create and show modal
          const modalHtml = `
            <div class="modal fade" id="exportFiltersModal" tabindex="-1" aria-labelledby="exportFiltersModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exportFiltersModalLabel">
                      <i class="bi bi-funnel me-2"></i>Export Products with Filters
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">Select Factories <span class="text-danger">*</span></label>
                        <div>
                          <button type="button" id="selectAllBtn" class="btn btn-sm btn-link p-0 me-2">Select All</button>
                          <button type="button" id="deselectAllBtn" class="btn btn-sm btn-link p-0">Deselect All</button>
                        </div>
                      </div>
                      <div id="factoriesLoading" class="text-center py-3">
                        <span class="spinner-border spinner-border-sm me-2"></span>Loading factories...
                      </div>
                      <div id="factoriesList" style="display: none; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 10px;">
                        <div id="factoriesCheckboxes"></div>
                      </div>
                      <div id="factoriesError" class="text-danger mt-2" style="display: none;"></div>
                      <small class="text-muted">Select one or more factories to export</small>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="exportPdfBtn" class="btn btn-primary" disabled>
                      <i class="bi bi-file-word me-1"></i>Export Word
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Remove existing modal if any
          const existingModal = document.getElementById('exportFiltersModal');
          if (existingModal) {
            existingModal.remove();
          }
          
          // Add modal to body
          document.body.insertAdjacentHTML('beforeend', modalHtml);
          
          // Show modal
          const modal = new bootstrap.Modal(document.getElementById('exportFiltersModal'));
          modal.show();
          
          // Load factories
          const factoriesLoading = document.getElementById('factoriesLoading');
          const factoriesList = document.getElementById('factoriesList');
          const factoriesError = document.getElementById('factoriesError');
          const factoriesCheckboxes = document.getElementById('factoriesCheckboxes');
          const exportPdfBtn = document.getElementById('exportPdfBtn');
          const selectAllBtn = document.getElementById('selectAllBtn');
          const deselectAllBtn = document.getElementById('deselectAllBtn');
          
          // Function to update export button state
          const updateExportButton = () => {
            const checked = factoriesCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
            exportPdfBtn.disabled = checked.length === 0;
          };
          
          try {
            const response = await fetch('/sudobe/api/content/products/factories');
            const result = await response.json();
            
            if (response.ok && result.success && result.factories) {
              factoriesLoading.style.display = 'none';
              factoriesList.style.display = 'block';
              
              // Clear existing checkboxes
              factoriesCheckboxes.innerHTML = '';
              
              // Add factory checkboxes
              result.factories.forEach(factory => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'form-check';
                checkboxDiv.innerHTML = `
                  <input class="form-check-input" type="checkbox" value="${factory.id}" id="factory_${factory.id}">
                  <label class="form-check-label" for="factory_${factory.id}">
                    ${factory.name || factory.id}
                  </label>
                `;
                factoriesCheckboxes.appendChild(checkboxDiv);
                
                // Add change listener to update export button
                checkboxDiv.querySelector('input').addEventListener('change', updateExportButton);
              });
              
              // Handle select all
              selectAllBtn.addEventListener('click', () => {
                factoriesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                  cb.checked = true;
                });
                updateExportButton();
              });
              
              // Handle deselect all
              deselectAllBtn.addEventListener('click', () => {
                factoriesCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                  cb.checked = false;
                });
                updateExportButton();
              });
              
              // Handle export PDF button
              exportPdfBtn.addEventListener('click', async () => {
                const checkedFactories = Array.from(factoriesCheckboxes.querySelectorAll('input[type="checkbox"]:checked'))
                  .map(cb => cb.value);
                
                if (checkedFactories.length === 0) return;
                
                exportPdfBtn.disabled = true;
                  exportPdfBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';
                
                try {
                  // Send factory IDs as comma-separated string
                  const factoryIdsParam = checkedFactories.join(',');
                  const exportResponse = await fetch(`/sudobe/api/content/products/export-pdf?factoryIds=${encodeURIComponent(factoryIdsParam)}`);
                  
                  if (exportResponse.ok) {
                    // Get filename from Content-Disposition header
                    const contentDisposition = exportResponse.headers.get('Content-Disposition');
                    let filename = 'products_export.docx';
                    
                    if (contentDisposition) {
                      const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                      if (filenameMatch) {
                        filename = filenameMatch[1];
                      }
                    }
                    
                    // Create blob and download
                    const blob = await exportResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Close modal
                    modal.hide();
                    
                    // Show success message
                    const alertHtml = `
                      <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        Products exported successfully! File: ${filename}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                      </div>
                    `;
                    formContainer.insertAdjacentHTML('afterbegin', alertHtml);
                  } else {
                    const errorData = await exportResponse.json();
                    throw new Error(errorData.error || 'Export failed');
                  }
                } catch (error) {
                  console.error('Error exporting PDF:', error);
                  factoriesError.textContent = 'Error exporting PDF: ' + error.message;
                  factoriesError.style.display = 'block';
                } finally {
                  exportPdfBtn.disabled = false;
                  exportPdfBtn.innerHTML = '<i class="bi bi-file-word me-1"></i>Export Word';
                }
              });
            } else {
              factoriesLoading.style.display = 'none';
              factoriesError.textContent = result.error || 'Failed to load factories';
              factoriesError.style.display = 'block';
            }
          } catch (error) {
            console.error('Error loading factories:', error);
            factoriesLoading.style.display = 'none';
            factoriesError.textContent = 'Error loading factories: ' + error.message;
            factoriesError.style.display = 'block';
          }
          
          // Clean up modal on close
          document.getElementById('exportFiltersModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
          });
        });
      };

      function loadProductsList(page = 1) {
        const limit = 20; // Products per page - set to 5 to test pagination
        
        // Show loading state
        formContainer.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-cart me-2"></i>Products List</h2>
            <div class="d-flex gap-2">
              <a href="?section=products" class="btn btn-outline-secondary">
                <i class="bi bi-upload me-1"></i>Import/Export
              </a>
              <a href="/sudobe/api/auth/logout" class="btn btn-outline-primary">
                <i class="bi bi-arrow-right me-1"></i>Logout
              </a>
            </div>
          </div>
          <div class="card">
            <div class="card-body text-center py-5">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading products and categories...</p>
            </div>
          </div>
        `;

        // Get filters from query parameters
        const factoryFilter = new URLSearchParams(window.location.search).get('factory') || '';
        const searchFilter = new URLSearchParams(window.location.search).get('search') || '';
        
        // Build API URL with filters if present
        let productsUrl = `/sudobe/api/content/products?page=${page}&limit=${limit}`;
        if (factoryFilter) {
          productsUrl += `&factory=${encodeURIComponent(factoryFilter)}`;
        }
        if (searchFilter) {
          productsUrl += `&search=${encodeURIComponent(searchFilter)}`;
        }
        
        // Fetch products, categories, and factories
        Promise.all([
          fetch(productsUrl).then(res => res.json()),
          fetch('/sudobe/api/content/categories').then(res => res.json()),
          fetch('/sudobe/api/content/factories').then(res => res.json())
        ])
          .then(([productsData, categoriesData, factoriesData]) => {
            const products = productsData.results || [];
            const categories = categoriesData || [];
            const factories = factoriesData || [];
            
            // Handle pagination data
            const pagination = productsData.pagination || {
              currentPage: page,
              totalPages: 1,
              totalProducts: products.length,
              hasNext: false,
              hasPrev: false,
              limit: limit
            };
            
            console.log('Products data:', productsData);
            console.log('Pagination:', pagination);
            
            // Create category map for quick lookup
            const categoryMap = {};
            categories.forEach(cat => {
              categoryMap[cat.id] = cat;
            });
            
            console.log('Total categories loaded:', categories.length);
            console.log('Category map keys:', Object.keys(categoryMap).length);
            let html = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-cart me-2"></i>Products List</h2>
                <div class="d-flex gap-2">
                  <select id="factoryFilter" class="form-select" style="width: 200px;">
                    <option value="">All Factories</option>
            `;
            
            // Add factory options
            factories.forEach(factory => {
              const factoryName = factory.content?.factory_name || factory.name || 'Unnamed Factory';
              const selected = factoryFilter === factory.id ? 'selected' : '';
              html += `<option value="${factory.id}" ${selected}>${factoryName}</option>`;
            });
            
            html += `
                  </select>
                  <input type="text" id="productSearch" class="form-control" placeholder="Search products..." style="width: 250px;" value="${searchFilter}">
                  <a href="?section=products" class="btn btn-outline-secondary">
                    <i class="bi bi-upload me-1"></i>Import/Export
                  </a>
                  <a href="/sudobe/api/auth/logout" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-right me-1"></i>Logout
                  </a>
                </div>
              </div>
              <div class="card">
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-hover table-sm">
                      <thead class="table-dark">
                        <tr>
                          <th style="min-width: 10rem;">Factory</th>
                          <th style="min-width: 10rem;">Images</th>
                          <th style="min-width: 20rem;">Product</th>
                          <th style="min-width: 10rem;">Category</th>
                          <th style="min-width: 10rem;">Sub-Category</th>
                          <th style="min-width: 10rem;">Unit per Carton</th>
                          <th style="min-width: 10rem;"> Selling Price</th>
                          <th style="min-width: 10rem;">Description</th>
                          <th style="min-width: 10rem;">Expiry (Months)</th>
                          <th style="min-width: 10rem;">Lead Time</th>
                          <th style="min-width: 10rem;">MOQ</th>
                          <th style="min-width: 10rem;">Loading per 20'</th>
                          <th style="min-width: 10rem;">Loading per 40'</th>
                        </tr>
                      </thead>
                      <tbody id="productsTableBody">
            `;

            if (products && products.length > 0) {
              products.forEach((product, index) => {
                const rowNumber = index + 1;
                const factory = product.content?.factory?.name || product.content?.factory_name || 'N/A';
                const productName = product.name || 'N/A';
                
                // Extract category and subcategory using category_id and categoryMap
                let category = 'N/A';
                let subCategory = 'N/A';
                
                if (product.category_id) {
                  if (categoryMap[product.category_id]) {
                    const productCategory = categoryMap[product.category_id];
                    
                    // If category has a parent_id, then it's a subcategory
                    if (productCategory.parent_id && categoryMap[productCategory.parent_id]) {
                      category = categoryMap[productCategory.parent_id].name || 'N/A';
                      subCategory = productCategory.name || 'N/A';
                    } else {
                      // It's a main category
                      category = productCategory.name || 'N/A';
                      subCategory = 'N/A';
                    }
                  } else {
                    console.warn(`Category ID ${product.category_id} not found in categoryMap for product: ${product.name}`);
                    console.warn(`Product ID: ${product.id}, Category ID: ${product.category_id}`);
                    console.warn(`Available category IDs:`, Object.keys(categoryMap));
                    category = `Missing (${product.category_id})`;
                  }
                } else {
                  console.warn(`Product has no category_id: ${product.name} (ID: ${product.id})`);
                }
                // Get size from weight array or fallback to weight_value/weight_unit
                
                const unitPerCarton = product.content?.unit_quantity || 'N/A';
                const sellingPrice = product.price ? `$${product.price.toFixed(2)}` : 'N/A';
                const factoryPrice = product.content?.factory_price_per_carton || 'N/A';
                const description = product.description ? product.description.substring(0, 50) + '...' : 'N/A';
                const expiry = product.content?.expiry_date || 'N/A';
                const leadTime = product.content?.min_days && product.content?.max_days 
                  ? `${product.content.min_days}-${product.content.max_days} days` 
                  : 'N/A';
                const moq = product.content?.minimum_quantity || 'N/A';
                const loading20 = product.content?.flc_quantity?.[0]?.['20_ft_'] || 'N/A';
                const loading40 = product.content?.flc_quantity?.[0]?.['40_ft_hc'] || 'N/A';
                const productDescription = product.description || 'N/A';
                
                // Get product images
                let imagesHtml = '';
                if (product.images && product.images.length > 0) {
                  imagesHtml = '<div class="d-flex gap-1 flex-wrap" style="max-width: 120px;">';
                  product.images.slice(0, 3).forEach(img => { // Show max 3 images
                    const imageUrl = img.file?.url || img.url || '';
                    if (imageUrl) {
                      imagesHtml += `
                        <img src="${imageUrl}" 
                             class="img-thumbnail" 
                             style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;" 
                             onclick="window.open('${imageUrl}', '_blank')"
                             title="Click to view full size" />
                      `;
                    }
                  });
                  if (product.images.length > 3) {
                    imagesHtml += `<small class="text-muted">+${product.images.length - 3}</small>`;
                  }
                  imagesHtml += '</div>';
                } else {
                  imagesHtml = '<span class="text-muted small">No images</span>';
                }
                
                html += `
                  <tr>
                    <td>${factory}</td>
                    <td>${imagesHtml}</td>
                    <td>
                      <strong>${productName}</strong>
                    </td>
                    <td>${category}</td>
                    <td>${subCategory}</td>
                    <td>${unitPerCarton}</td>
                    <td>${sellingPrice}</td>
                    <td style="max-width: 150px;" title="${description}">${description}</td>
                    <td>${expiry}</td>
                    <td>${leadTime}</td>
                    <td>${moq}</td>
                    <td>${loading20}</td>
                    <td>${loading40}</td>
                  </tr>
                `;
              });
            } else {
              const filterMessage = searchFilter 
                ? ` matching "${searchFilter}"` 
                : (factoryFilter ? ' for this factory' : '');
              html += `
                <tr>
                  <td colspan="13" class="text-center text-muted py-4">
                    <i class="bi bi-cart-x display-1 d-block mb-3"></i>
                    No products found${filterMessage}. 
                    ${searchFilter || factoryFilter ? '<a href="?section=products-list">Clear filters</a> or ' : ''}
                    <a href="?section=products">Import products</a>
                  </td>
                </tr>
              `;
            }

            html += `
                      </tbody>
                    </table>
                  </div>
            `;
            
            // Add pagination controls - always show for debugging
            console.log('Adding pagination controls. TotalPages:', pagination.totalPages, 'CurrentPage:', page);
            html += generateProductsPaginationControls(pagination, page);
            
            html += `
                </div>
              </div>
            `;

            formContainer.innerHTML = html;

            // Add factory filter functionality
            const factoryFilterSelect = document.getElementById('factoryFilter');
            if (factoryFilterSelect) {
              factoryFilterSelect.addEventListener('change', (e) => {
                const selectedFactory = e.target.value;
                const currentUrl = new URLSearchParams(window.location.search);
                currentUrl.set('section', 'products-list');
                
                // Always explicitly set page to 1 when factory filter changes
                currentUrl.set('page', '1');
                
                if (selectedFactory) {
                  currentUrl.set('factory', selectedFactory);
                } else {
                  currentUrl.delete('factory');
                }
                
                window.location.search = currentUrl.toString();
              });
            }
            
            // Add search functionality with debouncing
            const searchInput = document.getElementById('productSearch');
            if (searchInput) {
              let searchTimeout;
              searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(searchTimeout);
                
                // Wait 500ms after user stops typing before searching
                searchTimeout = setTimeout(() => {
                  const currentUrl = new URLSearchParams(window.location.search);
                  currentUrl.set('section', 'products-list');
                  
                  // Always explicitly set page to 1 when search changes
                  currentUrl.set('page', '1');
                  
                  if (searchTerm) {
                    currentUrl.set('search', searchTerm);
                  } else {
                    currentUrl.delete('search');
                  }
                  
                  window.location.search = currentUrl.toString();
                }, 500);
              });
            }
          })
          .catch(error => {
            console.error('Error loading products or categories:', error);
            formContainer.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-cart me-2"></i>Products List</h2>
                <a href="/sudobe/api/auth/logout" class="btn btn-outline-primary">
                  <i class="bi bi-arrow-right me-1"></i>Logout
                </a>
              </div>
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error loading products or categories: ${error.message}
              </div>
            `;
          });
      }

      function loadProtectionEditForm(protectionId) {
        formContainer.innerHTML = `
              <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Loading protection details...</p>
              </div>
            `;

        fetch(`/sudobe/api/content/protections`)
          .then(res => res.json())
          .then(protections => {
            const protection = protections.find(p => p.id === protectionId);
            if (protection) {
              loadProtectionForm(protection);
            } else {
              formContainer.innerHTML = `
                    <div class="alert alert-danger">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      Protection not found
                    </div>
                  `;
            }
          })
          .catch(error => {
            console.error('Error loading protection:', error);
            formContainer.innerHTML = `
                  <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error loading protection
                  </div>
                `;
          });
      }

      // === Banking Form ===
      function loadBankingForm() {
        formContainer.innerHTML = `
              <div class="mb-4">
                <h2><i class="bi bi-bank me-2"></i>Banking Details</h2>
              </div>
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title mb-0">Update Banking Information</h5>
                </div>
                <div class="card-body">
                  <form action="/sudobe/api/content/banking" method="POST">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label">Account Number <span class="text-danger">*</span></label>
                        <input type="text" name="accountNumber" class="form-control" required placeholder="Enter account number" />
                      </div>
                      <div class="col-md-6 mb-3">
                        <label class="form-label">SWIFT Code <span class="text-danger">*</span></label>
                        <input type="text" name="swiftCode" class="form-control" required placeholder="Enter SWIFT code" />
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Beneficiary Name <span class="text-danger">*</span></label>
                      <input type="text" name="beneficiaryName" class="form-control" required placeholder="Enter beneficiary name" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Beneficiary Address <span class="text-danger">*</span></label>
                      <textarea name="beneficiaryAddress" class="form-control" rows="3" required placeholder="Enter beneficiary address"></textarea>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Beneficiary Bank <span class="text-danger">*</span></label>
                      <input type="text" name="beneficiaryBank" class="form-control" required placeholder="Enter beneficiary bank name" />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Beneficiary Bank Address <span class="text-danger">*</span></label>
                      <textarea name="beneficiaryBankAddress" class="form-control" rows="3" required placeholder="Enter beneficiary bank address"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      <i class="bi bi-check-circle me-1"></i>Submit Banking Details
                    </button>
                  </form>
                </div>
              </div>
            `;
      }

      // === Global Functions (attached to window for onclick handlers) ===
      window.editBanner = function (id) {
        window.location.href = `?section=banner-edit&id=${id}`;
      };

      window.deleteBanner = function (id) {
        if (!confirm('Are you sure you want to delete this banner? This action cannot be undone.')) return;

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        fetch(`/sudobe/api/content/banners/${id}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              loadBannerList();
              // Show success message
              const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                      <i class="bi bi-check-circle me-2"></i>
                      Banner deleted successfully
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                  `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            } else {
              throw new Error('Server error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting banner. Please try again.');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          });
      };

      window.editProtection = function (id) {
        window.location.href = `?section=protection-edit&id=${id}`;
      };

      window.deleteProtection = function (id) {
        if (!confirm('Are you sure you want to delete this protection? This action cannot be undone.')) return;

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        fetch(`/sudobe/api/content/protections/${id}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              loadProtectionList();
              // Show success message
              const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                      <i class="bi bi-check-circle me-2"></i>
                      Protection deleted successfully
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                  `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            } else {
              throw new Error('Server error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting protection. Please try again.');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          });
      };

      // === Global Functions for Images ===
      window.viewImage = function (imageUrl) {
        // Open image in a new tab/window
        window.open(imageUrl, '_blank');
      };

      window.copyToClipboard = function (text) {
        navigator.clipboard.writeText(text).then(() => {
          // Show a brief success message
          const btn = event.target.closest('button');
          const originalIcon = btn.innerHTML;
          btn.innerHTML = '<i class="bi bi-check"></i>';
          btn.classList.remove('btn-outline-secondary');
          btn.classList.add('btn-success');
          
          setTimeout(() => {
            btn.innerHTML = originalIcon;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy: ', err);
          alert('Failed to copy URL to clipboard');
        });
      };

      window.deleteImage = function (id) {
        if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) return;

        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        btn.disabled = true;

        fetch(`/sudobe/api/content/images/${id}`, { method: 'DELETE' })
          .then(response => {
            if (response.ok) {
              loadImagesList();
              // Show success message
              const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                      <i class="bi bi-check-circle me-2"></i>
                      Image deleted successfully
                      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                  `;
              formContainer.insertAdjacentHTML('afterbegin', alertHtml);
            } else {
              throw new Error('Server error');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting image. Please try again.');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
          });
      };

      // === Global Functions for Products ===
      window.loadProductsList = loadProductsList;
      
      // === Global Functions for Images ===
      window.loadImagesList = loadImagesList;
    });
  </script>
</body>

</html>