<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customers - SODU CMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .sidebar {
      background-color: #f8f9fa;
      min-height: 100vh;
      border-right: 1px solid #dee2e6;
    }

    .sidebar .list-group-item {
      border: none;
      border-radius: 0;
    }

    .sidebar .list-group-item:hover {
      background-color: #e9ecef;
    }

    .sidebar .list-group-item.active {
      background-color: #0d6efd;
      color: white;
    }

    .sidebar .list-group-item a {
      text-decoration: none;
      color: inherit;
      display: block;
      width: 100%;
    }

    .main-content {
      padding: 20px;
    }

    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 20px;
    }

    .table-responsive {
      border-radius: 0.375rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        min-height: auto;
      }

      .main-content {
        padding: 10px;
      }

      .table-responsive {
        font-size: 0.875rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div id="sidebar-container"></div>

      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 main-content">
        <div id="alert-container"></div>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-people me-2"></i>Customers Management</h2>
          <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="showCustomerForm()">
            <i class="bi bi-plus-circle me-2"></i>Add New Customer
          </button>
            <a href="/api/auth/logout" class="btn btn-outline-secondary">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </div>
        </div>

        <!-- Customers Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">All Customers</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Vetted</th>
                    <th>Created At</th>
                    <th>Last Order At</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="customersTableBody">
                  <tr>
                    <td colspan="8" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Customer Form Modal -->
        <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="customerTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="customer-info-tab" data-bs-toggle="tab" data-bs-target="#customer-info" type="button" role="tab">
                      Customer Info
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" onclick="loadAddresses()">
                      Addresses
                    </button>
                  </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="customerTabContent">
                  <!-- Customer Info Tab -->
                  <div class="tab-pane fade show active" id="customer-info" role="tabpanel">
                    <form id="customerForm">
                      <input type="hidden" id="customerId">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="first_name" class="form-label">First Name *</label>
                          <input type="text" class="form-control" id="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="last_name" class="form-label">Last Name *</label>
                          <input type="text" class="form-control" id="last_name" required>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="email" class="form-label">Email *</label>
                          <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="phone" class="form-label">Phone</label>
                          <input type="text" class="form-control" id="phone" placeholder="201234567890" pattern="[0-9]*" inputmode="numeric">
                          <small class="form-text text-muted">Enter phone number with country code (no + sign). Example: 201234567890 (Egypt: 20 + phone number)</small>
                        </div>
                      </div>
                  <div class="mb-3">
                    <label for="password" class="form-label" id="passwordLabel">Password *</label>
                    <input type="password" class="form-control" id="password">
                    <small class="form-text text-muted" id="passwordHelp">Leave blank when editing to keep existing password</small>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="verified" role="switch">
                        <label class="form-check-label" for="verified">
                          Verified
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="vetted" role="switch">
                        <label class="form-check-label" for="vetted">
                          Vetted
                        </label>
                      </div>
                    </div>
                  </div>
                </form>
                  </div>
                  
                  <!-- Addresses Tab -->
                  <div class="tab-pane fade" id="addresses" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="mb-0">Customer Addresses</h6>
                      <button type="button" class="btn btn-sm btn-primary" onclick="showAddressForm()">
                        <i class="bi bi-plus-circle"></i> Add Address
                      </button>
                    </div>
                    <div id="addressesList" class="mt-3">
                      <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn" onclick="saveCustomer()">Save Customer</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Address Form Modal -->
        <div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addressModalTitle">Add Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="addressForm">
                  <input type="hidden" id="addressId">
                  <input type="hidden" id="addressParentId">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="address_first_name" class="form-label">First Name *</label>
                      <input type="text" class="form-control" id="address_first_name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="address_last_name" class="form-label">Last Name *</label>
                      <input type="text" class="form-control" id="address_last_name" required>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="address_company" class="form-label">Company</label>
                    <input type="text" class="form-control" id="address_company">
                  </div>
                  <div class="mb-3">
                    <label for="address_street" class="form-label">Street Address *</label>
                    <input type="text" class="form-control" id="address_street" required>
                  </div>
                  <div class="mb-3">
                    <label for="address_apt" class="form-label">Apt, Suite, etc.</label>
                    <input type="text" class="form-control" id="address_apt">
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="address_city" class="form-label">City</label>
                      <input type="text" class="form-control" id="address_city">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="address_state" class="form-label">State</label>
                      <input type="text" class="form-control" id="address_state">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="address_zip" class="form-label">ZIP Code</label>
                      <input type="text" class="form-control" id="address_zip">
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="address_country" class="form-label">Country</label>
                      <select class="form-select" id="address_country">
                        <option value="">Select country...</option>
                      </select>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="address_phone" class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="address_phone" placeholder="201234567890" pattern="[0-9]*" inputmode="numeric">
                    <small class="form-text text-muted">Enter phone number with country code (no + sign). Example: 201234567890 (Egypt: 20 + phone number)</small>
                  </div>
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="address_default">
                      <label class="form-check-label" for="address_default">
                        Set as default address
                      </label>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddressBtn" onclick="saveAddress()">Save Address</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Permissions Helper Script (must be loaded first) -->
  <script src="/js/permissions.js"></script>
  
  <!-- Shared Sidebar Component -->
  <script src="/js/sidebar.js"></script>

  <script>
    const API_BASE = '/customers/api';
    let customersModal;
    let addressModal;
    let currentCustomers = [];
    let currentAddresses = [];
    let currentCustomerId = null;

    // Country mapping
    const countryNameToCode = {
      'Afghanistan': 'AF', 'Albania': 'AL', 'Algeria': 'DZ', 'Andorra': 'AD', 'Angola': 'AO',
      'Antigua and Barbuda': 'AG', 'Argentina': 'AR', 'Armenia': 'AM', 'Australia': 'AU',
      'Austria': 'AT', 'Azerbaijan': 'AZ', 'Bahamas': 'BS', 'Bahrain': 'BH', 'Bangladesh': 'BD',
      'Barbados': 'BB', 'Belarus': 'BY', 'Belgium': 'BE', 'Belize': 'BZ', 'Benin': 'BJ',
      'Bhutan': 'BT', 'Bolivia': 'BO', 'Bosnia and Herzegovina': 'BA', 'Botswana': 'BW',
      'Brazil': 'BR', 'Brunei': 'BN', 'Bulgaria': 'BG', 'Burkina Faso': 'BF', 'Burundi': 'BI',
      'Cambodia': 'KH', 'Cameroon': 'CM', 'Canada': 'CA', 'Cape Verde': 'CV',
      'Central African Republic': 'CF', 'Chad': 'TD', 'Chile': 'CL', 'China': 'CN',
      'Colombia': 'CO', 'Comoros': 'KM', 'Congo': 'CG', 'Costa Rica': 'CR', 'Croatia': 'HR',
      'Cuba': 'CU', 'Cyprus': 'CY', 'Czech Republic': 'CZ', 'Denmark': 'DK', 'Djibouti': 'DJ',
      'Dominica': 'DM', 'Dominican Republic': 'DO', 'East Timor': 'TL', 'Ecuador': 'EC',
      'Egypt': 'EG', 'El Salvador': 'SV', 'Equatorial Guinea': 'GQ', 'Eritrea': 'ER',
      'Estonia': 'EE', 'Ethiopia': 'ET', 'Fiji': 'FJ', 'Finland': 'FI', 'France': 'FR',
      'Gabon': 'GA', 'Gambia': 'GM', 'Georgia': 'GE', 'Germany': 'DE', 'Ghana': 'GH',
      'Greece': 'GR', 'Grenada': 'GD', 'Guatemala': 'GT', 'Guinea': 'GN', 'Guinea-Bissau': 'GW',
      'Guyana': 'GY', 'Haiti': 'HT', 'Honduras': 'HN', 'Hungary': 'HU', 'Iceland': 'IS',
      'India': 'IN', 'Indonesia': 'ID', 'Iran': 'IR', 'Iraq': 'IQ', 'Ireland': 'IE',
      'Israel': 'IL', 'Italy': 'IT', 'Jamaica': 'JM', 'Japan': 'JP', 'Jordan': 'JO',
      'Kazakhstan': 'KZ', 'Kenya': 'KE', 'Kiribati': 'KI', 'North Korea': 'KP', 'South Korea': 'KR',
      'Kuwait': 'KW', 'Kyrgyzstan': 'KG', 'Laos': 'LA', 'Latvia': 'LV', 'Lebanon': 'LB',
      'Lesotho': 'LS', 'Liberia': 'LR', 'Libya': 'LY', 'Liechtenstein': 'LI', 'Lithuania': 'LT',
      'Luxembourg': 'LU', 'Madagascar': 'MG', 'Malawi': 'MW', 'Malaysia': 'MY', 'Maldives': 'MV',
      'Mali': 'ML', 'Malta': 'MT', 'Marshall Islands': 'MH', 'Mauritania': 'MR', 'Mauritius': 'MU',
      'Mexico': 'MX', 'Micronesia': 'FM', 'Moldova': 'MD', 'Monaco': 'MC', 'Mongolia': 'MN',
      'Montenegro': 'ME', 'Morocco': 'MA', 'Mozambique': 'MZ', 'Myanmar': 'MM', 'Namibia': 'NA',
      'Nauru': 'NR', 'Nepal': 'NP', 'Netherlands': 'NL', 'New Zealand': 'NZ', 'Nicaragua': 'NI',
      'Niger': 'NE', 'Nigeria': 'NG', 'North Macedonia': 'MK', 'Norway': 'NO', 'Oman': 'OM',
      'Pakistan': 'PK', 'Palau': 'PW', 'Panama': 'PA', 'Papua New Guinea': 'PG', 'Paraguay': 'PY',
      'Peru': 'PE', 'Philippines': 'PH', 'Poland': 'PL', 'Portugal': 'PT', 'Qatar': 'QA',
      'Romania': 'RO', 'Russia': 'RU', 'Rwanda': 'RW', 'Saint Kitts and Nevis': 'KN',
      'Saint Lucia': 'LC', 'Saint Vincent and the Grenadines': 'VC', 'Samoa': 'WS',
      'San Marino': 'SM', 'Sao Tome and Principe': 'ST', 'Saudi Arabia': 'SA', 'Senegal': 'SN',
      'Serbia': 'RS', 'Seychelles': 'SC', 'Sierra Leone': 'SL', 'Singapore': 'SG',
      'Slovakia': 'SK', 'Slovenia': 'SI', 'Solomon Islands': 'SB', 'Somalia': 'SO',
      'South Africa': 'ZA', 'South Sudan': 'SS', 'Spain': 'ES', 'Sri Lanka': 'LK',
      'Sudan': 'SD', 'Suriname': 'SR', 'Sweden': 'SE', 'Switzerland': 'CH', 'Syria': 'SY',
      'Taiwan': 'TW', 'Tajikistan': 'TJ', 'Tanzania': 'TZ', 'Thailand': 'TH', 'Togo': 'TG',
      'Tonga': 'TO', 'Trinidad and Tobago': 'TT', 'Tunisia': 'TN', 'Turkey': 'TR',
      'Turkmenistan': 'TM', 'Tuvalu': 'TV', 'Uganda': 'UG', 'Ukraine': 'UA',
      'United Arab Emirates': 'AE', 'United Kingdom': 'GB', 'United States': 'US',
      'Uruguay': 'UY', 'Uzbekistan': 'UZ', 'Vanuatu': 'VU', 'Vatican City': 'VA',
      'Venezuela': 'VE', 'Vietnam': 'VN', 'Yemen': 'YE', 'Zambia': 'ZM', 'Zimbabwe': 'ZW'
    };

    const countryCodeToName = {};
    Object.keys(countryNameToCode).forEach(name => {
      countryCodeToName[countryNameToCode[name]] = name;
    });

    const countries = Object.keys(countryNameToCode).sort();

    function getCountryCode(countryName) {
      return countryNameToCode[countryName] || countryName;
    }

    function getCountryName(countryCode) {
      return countryCodeToName[countryCode] || countryCode;
    }

    function populateCountryDropdown() {
      const select = document.getElementById('address_country');
      select.innerHTML = '<option value="">Select country...</option>';
      countries.forEach(countryName => {
        const option = document.createElement('option');
        option.value = countryName;
        option.textContent = countryName;
        select.appendChild(option);
      });
    }

    // Prevent "+" character in phone input fields
    function preventPlusInPhone(inputId) {
      const phoneInput = document.getElementById(inputId);
      if (phoneInput) {
        phoneInput.addEventListener('keydown', function(e) {
          // Prevent "+" key
          if (e.key === '+' || e.keyCode === 187) {
            e.preventDefault();
            return false;
          }
        });
        
        phoneInput.addEventListener('input', function(e) {
          // Remove "+" if pasted or entered
          this.value = this.value.replace(/\+/g, '');
        });
        
        phoneInput.addEventListener('paste', function(e) {
          // Remove "+" from pasted content
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData('text');
          const cleanedText = pastedText.replace(/\+/g, '');
          this.value = cleanedText;
        });
      }
    }

    // Frontend phone validation (same rules as backend)
    function validatePhoneNumberFrontend(phone) {
      if (!phone || phone.trim() === '') {
        return { valid: true, error: null }; // optional
      }

      const cleanedPhone = phone.trim();

      if (cleanedPhone.includes('+')) {
        return {
          valid: false,
          error: 'Phone number cannot contain "+" sign. Enter phone number with country code (no + sign). Example: 201234567890 (Egypt: 20 + phone number)'
        };
      }

      if (!/^\d+$/.test(cleanedPhone)) {
        return {
          valid: false,
          error: 'Phone number must contain only digits (no spaces, dashes, or special characters). Example: 201234567890'
        };
      }

      if (cleanedPhone.length < 10) {
        return {
          valid: false,
          error: 'Phone number must be at least 10 digits long (including country code). Example: 201234567890 (Egypt: 20 + phone number)'
        };
      }

      if (cleanedPhone.length > 15) {
        return {
          valid: false,
          error: 'Phone number cannot exceed 15 digits'
        };
      }

      return { valid: true, error: null };
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Prevent "+" in phone fields
      preventPlusInPhone('phone');
      preventPlusInPhone('address_phone');
      customersModal = new bootstrap.Modal(document.getElementById('customerModal'));
      addressModal = new bootstrap.Modal(document.getElementById('addressModal'));
      populateCountryDropdown();
      loadCustomers();
    });

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      alertContainer.innerHTML = alertHtml;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }

    async function loadCustomers() {
      try {
        const response = await fetch(API_BASE);
        const result = await response.json();
        
        if (result.success) {
          currentCustomers = result.data || [];
          renderCustomers();
        } else {
          showAlert('Failed to load customers', 'danger');
        }
      } catch (error) {
        console.error('Error loading customers:', error);
        showAlert('Error loading customers', 'danger');
      }
    }

    function renderCustomers() {
      const tbody = document.getElementById('customersTableBody');
      
      if (currentCustomers.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center text-muted">
              No customers found. Click "Add New Customer" to create one.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = currentCustomers.map(customer => {
        // Format created_at date
        let createdAt = 'N/A';
        if (customer.date_created) {
          const date = new Date(customer.date_created);
          createdAt = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }

        // Format last_order_at date
        let lastOrderAt = 'N/A';
        if (customer.last_order_at) {
          const lastOrderDate = new Date(customer.last_order_at);
          lastOrderAt = lastOrderDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
        
        // Vetted status badge
        const isVetted = customer.content?.vetted === true;
        const vettedBadge = isVetted 
          ? '<span class="badge bg-success">Yes</span>' 
          : '<span class="badge bg-secondary">No</span>';
        
        return `
          <tr>
            <td>${customer.first_name || 'N/A'}</td>
            <td>${customer.last_name || 'N/A'}</td>
            <td>${customer.email || 'N/A'}</td>
            <td>${customer.phone || 'N/A'}</td>
            <td>${vettedBadge}</td>
            <td>${createdAt}</td>
            <td>${lastOrderAt}</td>
            <td>
              <button class="btn btn-sm btn-primary me-2" onclick="editCustomer('${customer.id}')">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${customer.id}', this)">
                <i class="bi bi-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showCustomerForm(customerId = null) {
      const form = document.getElementById('customerForm');
      const modalTitle = document.getElementById('customerModalTitle');
      const passwordLabel = document.getElementById('passwordLabel');
      const passwordHelp = document.getElementById('passwordHelp');
      const passwordInput = document.getElementById('password');
      
      form.reset();
      document.getElementById('customerId').value = '';
      currentCustomerId = customerId;
      
      // Reset to Customer Info tab
      const customerInfoTab = document.getElementById('customer-info-tab');
      const addressesTab = document.getElementById('addresses-tab');
      const customerInfoPane = document.getElementById('customer-info');
      const addressesPane = document.getElementById('addresses');
      customerInfoTab.classList.add('active');
      addressesTab.classList.remove('active');
      customerInfoPane.classList.add('active', 'show');
      addressesPane.classList.remove('active', 'show');
      
      if (customerId) {
        modalTitle.textContent = 'Edit Customer';
        passwordLabel.textContent = 'Password (leave blank to keep existing)';
        passwordInput.required = false;
        passwordHelp.style.display = 'block';
        
        const customer = currentCustomers.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('customerId').value = customer.id;
          document.getElementById('first_name').value = customer.first_name || '';
          document.getElementById('last_name').value = customer.last_name || '';
          document.getElementById('email').value = customer.email || '';
          document.getElementById('phone').value = customer.phone || '';
          document.getElementById('verified').checked = customer.content?.verified === true;
          document.getElementById('vetted').checked = customer.content?.vetted === true;
        }
      } else {
        modalTitle.textContent = 'Add Customer';
        passwordLabel.textContent = 'Password *';
        passwordInput.required = true;
        passwordHelp.style.display = 'none';
        document.getElementById('verified').checked = false;
        document.getElementById('vetted').checked = false;
      }
      
      customersModal.show();
    }

    async function saveCustomer() {
      const form = document.getElementById('customerForm');
      const saveBtn = document.getElementById('saveCustomerBtn');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const customerId = document.getElementById('customerId').value;
      const password = document.getElementById('password').value;
      const phoneValue = document.getElementById('phone').value;

      // Frontend phone validation
      const phoneValidation = validatePhoneNumberFrontend(phoneValue);
      if (!phoneValidation.valid) {
        showAlert(phoneValidation.error, 'danger');
        return;
      }
      
      const data = {
        first_name: document.getElementById('first_name').value,
        last_name: document.getElementById('last_name').value,
        email: document.getElementById('email').value,
        phone: phoneValue,
        verified: document.getElementById('verified').checked,
        vetted: document.getElementById('vetted').checked
      };

      // Only include password if it's provided (for create) or if it's being updated
      if (password && password.trim() !== '') {
        data.password = password;
      }

      // Disable save button and show loading state
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.dataset.originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
      }

      try {
        const url = customerId ? `${API_BASE}/${customerId}` : API_BASE;
        const method = customerId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert(customerId ? 'Customer updated successfully' : 'Customer created successfully');
          customersModal.hide();
          loadCustomers();
        } else {
          showAlert(result.message || 'Failed to save customer', 'danger');
        }
      } catch (error) {
        console.error('Error saving customer:', error);
        showAlert('Error saving customer', 'danger');
      } finally {
        // Re-enable save button and restore text
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = saveBtn.dataset.originalText || 'Save Customer';
        }
      }
    }

    function editCustomer(customerId) {
      showCustomerForm(customerId);
    }

    async function deleteCustomer(customerId, btn) {
      if (!confirm('Are you sure you want to delete this customer?')) {
        return;
      }

      // Disable delete button and show loading state
      let originalHtml;
      if (btn) {
        btn.disabled = true;
        originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Deleting...';
      }

      try {
        const response = await fetch(`${API_BASE}/${customerId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert('Customer deleted successfully');
          loadCustomers();
        } else {
          showAlert(result.message || 'Failed to delete customer', 'danger');
        }
      } catch (error) {
        console.error('Error deleting customer:', error);
        showAlert('Error deleting customer', 'danger');
      } finally {
        // Re-enable delete button and restore text
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalHtml || '<i class="bi bi-trash"></i> Delete';
        }
      }
    }

    // Address Management Functions
    async function loadAddresses() {
      if (!currentCustomerId) {
        document.getElementById('addressesList').innerHTML = `
          <div class="alert alert-info">
            Please save the customer first before adding addresses.
          </div>
        `;
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/${currentCustomerId}/addresses`);
        const result = await response.json();
        
        if (result.success) {
          currentAddresses = result.addresses || [];
          renderAddresses();
        } else {
          document.getElementById('addressesList').innerHTML = `
            <div class="alert alert-danger">
              Failed to load addresses: ${result.message || 'Unknown error'}
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading addresses:', error);
        document.getElementById('addressesList').innerHTML = `
          <div class="alert alert-danger">
            Error loading addresses: ${error.message}
          </div>
        `;
      }
    }

    function renderAddresses() {
      const container = document.getElementById('addressesList');
      
      if (currentAddresses.length === 0) {
        container.innerHTML = `
          <div class="alert alert-info">
            No addresses found. Click "Add Address" to create one.
          </div>
        `;
        return;
      }

      container.innerHTML = currentAddresses.map(address => {
        const countryName = getCountryName(address.country || '');
        return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="card-title">
                    ${address.first_name || ''} ${address.last_name || ''}
                  </h6>
                  ${address.company ? `<p class="text-muted mb-1"><small>${address.company}</small></p>` : ''}
                  <p class="mb-1">${address.address1 || ''}</p>
                  ${address.address2 ? `<p class="mb-1">${address.address2}</p>` : ''}
                  <p class="mb-1">
                    ${address.city || ''}${address.state ? `, ${address.state}` : ''} ${address.zip || ''}
                  </p>
                  <p class="mb-1">${countryName || ''}</p>
                  ${address.phone ? `<p class="mb-0"><small>Phone: ${address.phone}</small></p>` : ''}
                </div>
                <div>
                  <button class="btn btn-sm btn-primary me-2" onclick="editAddress('${address.id}')">
                    <i class="bi bi-pencil"></i> Edit
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteAddress('${address.id}')">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showAddressForm(addressId = null) {
      if (!currentCustomerId) {
        showAlert('Please save the customer first before adding addresses', 'warning');
        return;
      }

      const form = document.getElementById('addressForm');
      const modalTitle = document.getElementById('addressModalTitle');
      
      form.reset();
      document.getElementById('addressId').value = '';
      document.getElementById('addressParentId').value = currentCustomerId;
      
      if (addressId) {
        modalTitle.textContent = 'Edit Address';
        const address = currentAddresses.find(a => a.id === addressId);
        if (address) {
          document.getElementById('addressId').value = address.id;
          document.getElementById('addressParentId').value = address.parent_id;
          document.getElementById('address_first_name').value = address.first_name || '';
          document.getElementById('address_last_name').value = address.last_name || '';
          document.getElementById('address_company').value = address.company || '';
          document.getElementById('address_street').value = address.address1 || '';
          document.getElementById('address_apt').value = address.address2 || '';
          document.getElementById('address_city').value = address.city || '';
          document.getElementById('address_state').value = address.state || '';
          document.getElementById('address_zip').value = address.zip || '';
          document.getElementById('address_phone').value = address.phone || '';
          const countryName = getCountryName(address.country || '');
          document.getElementById('address_country').value = countryName;
          document.getElementById('address_default').checked = address.active || false;
        }
      } else {
        modalTitle.textContent = 'Add Address';
        document.getElementById('address_default').checked = false;
      }
      
      addressModal.show();
    }

    async function saveAddress() {
      const form = document.getElementById('addressForm');
      const saveBtn = document.getElementById('saveAddressBtn');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const addressId = document.getElementById('addressId').value;
      const parentId = document.getElementById('addressParentId').value;
      const countryName = document.getElementById('address_country').value;
      const countryCode = countryName ? getCountryCode(countryName) : '';
      const isDefault = document.getElementById('address_default').checked;
      const addressPhoneValue = document.getElementById('address_phone').value;

      // Frontend phone validation for address
      const phoneValidation = validatePhoneNumberFrontend(addressPhoneValue);
      if (!phoneValidation.valid) {
        showAlert(phoneValidation.error, 'danger');
        return;
      }
      
      const data = {
        parent_id: parentId,
        first_name: document.getElementById('address_first_name').value,
        last_name: document.getElementById('address_last_name').value,
        company: document.getElementById('address_company').value || null,
        address1: document.getElementById('address_street').value,
        address2: document.getElementById('address_apt').value || null,
        city: document.getElementById('address_city').value || null,
        state: document.getElementById('address_state').value || null,
        zip: document.getElementById('address_zip').value || null,
        country: countryCode || null,
        phone: addressPhoneValue || null,
        active: isDefault
      };

      // Disable save button and show loading state
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.dataset.originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';
      }

      try {
        const url = addressId ? `${API_BASE}/addresses/${addressId}` : `${API_BASE}/addresses`;
        const method = addressId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert(addressId ? 'Address updated successfully' : 'Address created successfully');
          addressModal.hide();
          loadAddresses();
        } else {
          showAlert(result.message || 'Failed to save address', 'danger');
        }
      } catch (error) {
        console.error('Error saving address:', error);
        showAlert('Error saving address', 'danger');
      } finally {
        // Re-enable save button and restore text
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = saveBtn.dataset.originalText || 'Save Address';
        }
      }
    }

    function editAddress(addressId) {
      showAddressForm(addressId);
    }

    async function deleteAddress(addressId) {
      if (!confirm('Are you sure you want to delete this address?')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/addresses/${addressId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert('Address deleted successfully');
          loadAddresses();
        } else {
          showAlert(result.message || 'Failed to delete address', 'danger');
        }
      } catch (error) {
        console.error('Error deleting address:', error);
        showAlert('Error deleting address', 'danger');
      }
    }
  </script>
</body>

</html>

