<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shipping Rates - SODU CMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .sidebar {
      background-color: #f8f9fa;
      min-height: 100vh;
      border-right: 1px solid #dee2e6;
    }

    .sidebar .list-group-item {
      border: none;
      border-radius: 0;
    }

    .sidebar .list-group-item:hover {
      background-color: #e9ecef;
    }

    .sidebar .list-group-item.active {
      background-color: #0d6efd;
      color: white;
    }

    .sidebar .list-group-item a {
      text-decoration: none;
      color: inherit;
      display: block;
      width: 100%;
    }

    .main-content {
      padding: 20px;
    }

    .card {
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      margin-bottom: 20px;
    }

    .table-responsive {
      border-radius: 0.375rem;
    }

    .badge-active {
      background-color: #198754;
    }

    .badge-inactive {
      background-color: #6c757d;
    }

    @media (max-width: 768px) {
      .sidebar {
        min-height: auto;
      }

      .main-content {
        padding: 10px;
      }

      .table-responsive {
        font-size: 0.875rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div id="sidebar-container"></div>
      <!-- Main Content -->
      <div class="col-md-9 col-lg-10 main-content">
        <div id="alert-container"></div>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="bi bi-truck me-2"></i>Shipping Rates Management</h2>
          <div class="d-flex gap-2">
          <button class="btn btn-primary" onclick="showRateForm()">
            <i class="bi bi-plus-circle me-2"></i>Add New Rate
          </button>
            <a href="/sudobe/api/auth/logout" class="btn btn-outline-secondary">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </div>
        </div>

        <!-- Shipping Rates Table -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">All Shipping Rates</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Min Rate</th>
                    <th>Max Rate</th>
                    <th>Min Days</th>
                    <th>Max Days</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="ratesTableBody">
                  <tr>
                    <td colspan="6" class="text-center">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Rate Form Modal -->
        <div class="modal fade" id="rateModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="rateModalTitle">Add Shipping Rate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="rateForm">
                  <input type="hidden" id="rateId">
                  <div class="mb-3">
                    <label for="country_name" class="form-label">Country Name *</label>
                    <select class="form-select" id="country_name" required>
                      <option value="">Select a country</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="min_rate" class="form-label">Min Rate *</label>
                    <input type="text" class="form-control" id="min_rate" required>
                    <small class="form-text text-muted">Enter minimum rate (text field)</small>
                  </div>
                  <div class="mb-3">
                    <label for="max_rate" class="form-label">Max Rate *</label>
                    <input type="text" class="form-control" id="max_rate" required>
                    <small class="form-text text-muted">Enter maximum rate (text field)</small>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="min_days" class="form-label">Min Days</label>
                      <input type="number" class="form-control" id="min_days" min="0" placeholder="Minimum shipping days">
                      <small class="form-text text-muted">Minimum shipping duration in days</small>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="max_days" class="form-label">Max Days</label>
                      <input type="number" class="form-control" id="max_days" min="0" placeholder="Maximum shipping days">
                      <small class="form-text text-muted">Maximum shipping duration in days</small>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRate()">Save Rate</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Permissions Helper Script (must be loaded first) -->
  <script src="/sudobe/js/permissions.js"></script>
  
  <!-- Shared Sidebar Component -->
  <script src="/sudobe/js/sidebar.js"></script>

  <script>
    const API_BASE = '/shipping-rates/api';
    let ratesModal;
    let currentRates = [];

    // Mapping of country names to ISO 2-letter country codes
    const countryNameToCode = {
      'Afghanistan': 'AF', 'Albania': 'AL', 'Algeria': 'DZ', 'Andorra': 'AD', 'Angola': 'AO',
      'Antigua and Barbuda': 'AG', 'Argentina': 'AR', 'Armenia': 'AM', 'Australia': 'AU',
      'Austria': 'AT', 'Azerbaijan': 'AZ', 'Bahamas': 'BS', 'Bahrain': 'BH', 'Bangladesh': 'BD',
      'Barbados': 'BB', 'Belarus': 'BY', 'Belgium': 'BE', 'Belize': 'BZ', 'Benin': 'BJ',
      'Bhutan': 'BT', 'Bolivia': 'BO', 'Bosnia and Herzegovina': 'BA', 'Botswana': 'BW',
      'Brazil': 'BR', 'Brunei': 'BN', 'Bulgaria': 'BG', 'Burkina Faso': 'BF', 'Burundi': 'BI',
      'Cambodia': 'KH', 'Cameroon': 'CM', 'Canada': 'CA', 'Cape Verde': 'CV',
      'Central African Republic': 'CF', 'Chad': 'TD', 'Chile': 'CL', 'China': 'CN',
      'Colombia': 'CO', 'Comoros': 'KM', 'Congo': 'CG', 'Costa Rica': 'CR', 'Croatia': 'HR',
      'Cuba': 'CU', 'Cyprus': 'CY', 'Czech Republic': 'CZ', 'Denmark': 'DK', 'Djibouti': 'DJ',
      'Dominica': 'DM', 'Dominican Republic': 'DO', 'East Timor': 'TL', 'Ecuador': 'EC',
      'Egypt': 'EG', 'El Salvador': 'SV', 'Equatorial Guinea': 'GQ', 'Eritrea': 'ER',
      'Estonia': 'EE', 'Ethiopia': 'ET', 'Fiji': 'FJ', 'Finland': 'FI', 'France': 'FR',
      'Gabon': 'GA', 'Gambia': 'GM', 'Georgia': 'GE', 'Germany': 'DE', 'Ghana': 'GH',
      'Greece': 'GR', 'Grenada': 'GD', 'Guatemala': 'GT', 'Guinea': 'GN', 'Guinea-Bissau': 'GW',
      'Guyana': 'GY', 'Haiti': 'HT', 'Honduras': 'HN', 'Hungary': 'HU', 'Iceland': 'IS',
      'India': 'IN', 'Indonesia': 'ID', 'Iran': 'IR', 'Iraq': 'IQ', 'Ireland': 'IE',
      'Israel': 'IL', 'Italy': 'IT', 'Jamaica': 'JM', 'Japan': 'JP', 'Jordan': 'JO',
      'Kazakhstan': 'KZ', 'Kenya': 'KE', 'Kiribati': 'KI', 'North Korea': 'KP', 'South Korea': 'KR',
      'Kuwait': 'KW', 'Kyrgyzstan': 'KG', 'Laos': 'LA', 'Latvia': 'LV', 'Lebanon': 'LB',
      'Lesotho': 'LS', 'Liberia': 'LR', 'Libya': 'LY', 'Liechtenstein': 'LI', 'Lithuania': 'LT',
      'Luxembourg': 'LU', 'Madagascar': 'MG', 'Malawi': 'MW', 'Malaysia': 'MY', 'Maldives': 'MV',
      'Mali': 'ML', 'Malta': 'MT', 'Marshall Islands': 'MH', 'Mauritania': 'MR', 'Mauritius': 'MU',
      'Mexico': 'MX', 'Micronesia': 'FM', 'Moldova': 'MD', 'Monaco': 'MC', 'Mongolia': 'MN',
      'Montenegro': 'ME', 'Morocco': 'MA', 'Mozambique': 'MZ', 'Myanmar': 'MM', 'Namibia': 'NA',
      'Nauru': 'NR', 'Nepal': 'NP', 'Netherlands': 'NL', 'New Zealand': 'NZ', 'Nicaragua': 'NI',
      'Niger': 'NE', 'Nigeria': 'NG', 'North Macedonia': 'MK', 'Norway': 'NO', 'Oman': 'OM',
      'Pakistan': 'PK', 'Palau': 'PW', 'Panama': 'PA', 'Papua New Guinea': 'PG', 'Paraguay': 'PY',
      'Peru': 'PE', 'Philippines': 'PH', 'Poland': 'PL', 'Portugal': 'PT', 'Qatar': 'QA',
      'Romania': 'RO', 'Russia': 'RU', 'Rwanda': 'RW', 'Saint Kitts and Nevis': 'KN',
      'Saint Lucia': 'LC', 'Saint Vincent and the Grenadines': 'VC', 'Samoa': 'WS',
      'San Marino': 'SM', 'Sao Tome and Principe': 'ST', 'Saudi Arabia': 'SA', 'Senegal': 'SN',
      'Serbia': 'RS', 'Seychelles': 'SC', 'Sierra Leone': 'SL', 'Singapore': 'SG',
      'Slovakia': 'SK', 'Slovenia': 'SI', 'Solomon Islands': 'SB', 'Somalia': 'SO',
      'South Africa': 'ZA', 'South Sudan': 'SS', 'Spain': 'ES', 'Sri Lanka': 'LK',
      'Sudan': 'SD', 'Suriname': 'SR', 'Sweden': 'SE', 'Switzerland': 'CH', 'Syria': 'SY',
      'Taiwan': 'TW', 'Tajikistan': 'TJ', 'Tanzania': 'TZ', 'Thailand': 'TH', 'Togo': 'TG',
      'Tonga': 'TO', 'Trinidad and Tobago': 'TT', 'Tunisia': 'TN', 'Turkey': 'TR',
      'Turkmenistan': 'TM', 'Tuvalu': 'TV', 'Uganda': 'UG', 'Ukraine': 'UA',
      'United Arab Emirates': 'AE', 'United Kingdom': 'GB', 'United States': 'US',
      'Uruguay': 'UY', 'Uzbekistan': 'UZ', 'Vanuatu': 'VU', 'Vatican City': 'VA',
      'Venezuela': 'VE', 'Vietnam': 'VN', 'Yemen': 'YE', 'Zambia': 'ZM', 'Zimbabwe': 'ZW'
    };

    // Reverse mapping: country code to country name
    const countryCodeToName = {};
    Object.keys(countryNameToCode).forEach(name => {
      countryCodeToName[countryNameToCode[name]] = name;
    });

    // List of country names for dropdown (sorted)
    const countries = Object.keys(countryNameToCode).sort();

    // Helper functions
    function getCountryCode(countryName) {
      return countryNameToCode[countryName] || countryName;
    }

    function getCountryName(countryCode) {
      return countryCodeToName[countryCode] || countryCode;
    }

    document.addEventListener('DOMContentLoaded', () => {
      ratesModal = new bootstrap.Modal(document.getElementById('rateModal'));
      populateCountryDropdown();
      loadRates();
    });

    function populateCountryDropdown() {
      const select = document.getElementById('country_name');
      countries.forEach(countryName => {
        const option = document.createElement('option');
        option.value = countryName; // Store country name in value, but we'll convert to code on save
        option.textContent = countryName;
        select.appendChild(option);
      });
    }

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alert-container');
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      alertContainer.innerHTML = alertHtml;
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }

    async function loadRates() {
      try {
        const response = await fetch(API_BASE);
        const result = await response.json();
        
        if (result.success) {
          currentRates = result.data || [];
          renderRates();
        } else {
          showAlert('Failed to load shipping rates', 'danger');
        }
      } catch (error) {
        console.error('Error loading rates:', error);
        showAlert('Error loading shipping rates', 'danger');
      }
    }

    function renderRates() {
      const tbody = document.getElementById('ratesTableBody');
      
      if (currentRates.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted">
              No shipping rates found. Click "Add New Rate" to create one.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = currentRates.map(rate => {
        const content = rate.content || {};
        // Convert country code to country name for display
        const countryName = getCountryName(content.country_name || '');
        const shippingRates = content.shipping_rates || {};
        const minDays = (shippingRates.min_days !== undefined && shippingRates.min_days !== null) ? shippingRates.min_days : 'N/A';
        const maxDays = (shippingRates.max_days !== undefined && shippingRates.max_days !== null) ? shippingRates.max_days : 'N/A';
        return `
          <tr>
            <td>${countryName}</td>
            <td>${content.min_rate || 'N/A'}</td>
            <td>${content.max_rate || 'N/A'}</td>
            <td>${minDays}</td>
            <td>${maxDays}</td>
            <td>
              <button class="btn btn-sm btn-primary me-2" onclick="editRate('${rate.id}')">
                <i class="bi bi-pencil"></i> Edit
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteRate('${rate.id}')">
                <i class="bi bi-trash"></i> Delete
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showRateForm(rateId = null) {
      const form = document.getElementById('rateForm');
      const modalTitle = document.getElementById('rateModalTitle');
      
      form.reset();
      document.getElementById('rateId').value = '';
      
      if (rateId) {
        modalTitle.textContent = 'Edit Shipping Rate';
        const rate = currentRates.find(r => r.id === rateId);
        if (rate) {
          const content = rate.content || {};
          const shippingRates = content.shipping_rates || {};
          document.getElementById('rateId').value = rate.id;
          // Convert country code to country name for dropdown selection
          const countryName = getCountryName(content.country_name || '');
          document.getElementById('country_name').value = countryName;
          document.getElementById('min_rate').value = content.min_rate || '';
          document.getElementById('max_rate').value = content.max_rate || '';
          document.getElementById('min_days').value = shippingRates.min_days || shippingRates.min_days === 0 ? shippingRates.min_days : '';
          document.getElementById('max_days').value = shippingRates.max_days || shippingRates.max_days === 0 ? shippingRates.max_days : '';
        }
      } else {
        modalTitle.textContent = 'Add Shipping Rate';
        document.getElementById('min_days').value = '';
        document.getElementById('max_days').value = '';
      }
      
      ratesModal.show();
    }

    async function saveRate() {
      const form = document.getElementById('rateForm');
      
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const rateId = document.getElementById('rateId').value;
      const selectedCountryName = document.getElementById('country_name').value;
      // Convert country name to country code before saving
      const countryCode = getCountryCode(selectedCountryName);
      
      const minDays = document.getElementById('min_days').value.trim();
      const maxDays = document.getElementById('max_days').value.trim();
      
      const data = {
        country_name: countryCode, // Store country code (e.g., "EG" instead of "Egypt")
        min_rate: document.getElementById('min_rate').value,
        max_rate: document.getElementById('max_rate').value,
        shipping_rates: {}
      };
      
      // Only include min_days and max_days if they have values
      if (minDays) {
        data.shipping_rates.min_days = parseInt(minDays);
      }
      if (maxDays) {
        data.shipping_rates.max_days = parseInt(maxDays);
      }
      
      // If shipping_rates object is empty, don't include it
      if (Object.keys(data.shipping_rates).length === 0) {
        delete data.shipping_rates;
      }

      try {
        const url = rateId ? `${API_BASE}/${rateId}` : API_BASE;
        const method = rateId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert(rateId ? 'Shipping rate updated successfully' : 'Shipping rate created successfully');
          ratesModal.hide();
          loadRates();
        } else {
          showAlert(result.message || 'Failed to save shipping rate', 'danger');
        }
      } catch (error) {
        console.error('Error saving rate:', error);
        showAlert('Error saving shipping rate', 'danger');
      }
    }

    function editRate(rateId) {
      showRateForm(rateId);
    }

    async function deleteRate(rateId) {
      if (!confirm('Are you sure you want to delete this shipping rate?')) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/${rateId}`, {
          method: 'DELETE'
        });

        const result = await response.json();
        
        if (result.success) {
          showAlert('Shipping rate deleted successfully');
          loadRates();
        } else {
          showAlert(result.message || 'Failed to delete shipping rate', 'danger');
        }
      } catch (error) {
        console.error('Error deleting rate:', error);
        showAlert('Error deleting shipping rate', 'danger');
      }
    }
  </script>
</body>

</html>

